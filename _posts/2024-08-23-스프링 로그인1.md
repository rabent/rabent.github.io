---
title: "스프링 MVC-스프링 로그인-쿠키와 세션"
layout: post
date: 2024-08-23 15:30
tag:
- Spring
- JAVA
description: 스프링 입문 강의 핵심 정리
---  

# 로그인  
웹 페이지에서 페이지에 접근할 권한을 부여하고 회원의 데이터를 관리하기 위해서는 로그인 기능이 필수적이다.  
우리는 앞으로 로그인 기능을 통해 가입된 회원의 **로그인과 로그아웃** 및 로그인 되지 않은 회원에 대한 **페이지 접근 거부**를 구현할 것이다.  
그리고 해당 기능의 구현을 위해 이전 HTTP 포스팅에서 배웠던 **쿠키를 스프링에서 어떻게 사용하는지**를 알아보고 **세션이란 무엇인지**에 대해 배워볼 것이다.  

# 로그인 구현  
회원의 등록과 회원 찾기 등의 기능은 이전 포스티에서 질리도록 구현했던 것들과 거의 동일하니 넘어가도록 하겠다.  
{% highlight java %}
@Service
@RequiredArgsConstructor
public class LoginService {
    private final MemberRepository memberRepository;
    /**
    * @return null이면 로그인 실패
        */
    public Member login(String loginId, String password) {
    return memberRepository.findByLoginId(loginId)
    .filter(m -> m.getPassword().equals(password))
    .orElse(null);
    }
}
{% endhighlight %}  
id와 password를 받아온 후 db에 있는지 확인하는 로직을 서비스로 따로 만들어주었다. 이후 작성할 컨트롤러에서 사용할 것이다.  

{% highlight java %}
@Controller
@Slf4j
@RequiredArgsConstructor
public class LoginController {
    final LoginService loginService;
    final SessionManager sessionManager;

    @GetMapping("/login")
    public String loginForm(@ModelAttribute("loginForm") LoginForm form) {
        return "login/loginForm";
    }

    //@PostMapping("/login")
    public String login(@Validated @ModelAttribute LoginForm form, BindingResult bindingResult, HttpServletResponse response) {
        if(bindingResult.hasErrors()) {
            return "login/loginForm";
        }

        Member loginMember = loginService.login(form.getLoginId(), form.getPassword());

        if(loginMember==null) {
            bindingResult.reject("loginFail", "아이디 또는 비밀번호가 맞지 않습니다.");
            return "login/loginForm";
        }
        
        //쿠키에 시간정보를 주지않으면 세션 쿠키
        Cookie idCookie = new Cookie("memberId", String.valueOf(loginMember.getId()));
        response.addCookie(idCookie);
        return "redirect:/";
    }

    @PostMapping("/logout")
    public String logout(HttpServletResponse response) {
        expireCookie(response, "memberId");
        return "redirect:/";
    }  

    private static void expireCookie(HttpServletResponse response, String cookieName) {
        Cookie cookie = new Cookie(cookieName, null);
        cookie.setMaxAge(0);
        response.addCookie(cookie);
    }
}
{% endhighlight %}  
쿠키를 사용해 구현한 로그인과 로그아웃 기능이다. 예외가 발생하면 폼으로 다시 돌아가도록 했고, 위에 작성한 로그인 서비스에서 id와 password를 확인하여 유효하지 않아도 폼으로 다시 돌아가도록 했다.  

만약 로그인에 성공했다면 시간정보가 없는 세션 쿠키를 로그인 멤버의 id를 value로 발행한 후 홈으로 리다이렉트 하도록 하였다.  
로그아웃 할 경우 같은 이름의 수명이 0인 쿠키를 발행하여 쿠키를 삭제하여 더이상 로그인 상태가 아니도록 하였다.  

발행한 쿠키는 아래 그림과 같이 작동한다.  

![쿠키 1](/assets/img/쿠키%201.png)  

![쿠키 2](/assets/img/쿠키%202.png)  


